name: Update repository from Cookiecutter

on:
  workflow_call:
    secrets:
      AWS_GITHUBRUNNER_PAT:
        required: true
      COOKIECUTTER_SSH_PRIVATE_KEY:
        required: true 

jobs:
  check_existing_prs:
    runs-on: ubuntu-latest
    outputs:
      pr_already_open: ${{ steps.check_prs_open.outputs.result }}
    steps:
      - name: Check if Accept PR already open
        uses: actions/github-script@v7
        id: check_prs_open
        with:
          result-encoding: string
          retries: 2
          script: |
            const openPullReqs = await github.rest.pulls.list({
                owner: context.repo.owner,
                repo: context.repo.repo,
                state: 'open'
            });

            let detectedAcceptPR = false;

            openPullReqs.data.forEach(pr => {
              if (pr.title.includes("accept-pr")) {
                console.log(pr.html_url);
                detectedAcceptPR = true;
              }
            });

            result = detectedAcceptPR;
            console.log(`Accept PR already open: ${result}`);
            return result;

  update:
    if: needs.check_existing_prs.outputs.pr_already_open == 'false'
    needs:
      - check_existing_prs
    name: ${{ matrix.type }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: true
      matrix:
        include:
          - type: accept-pr
            add-paths: .
            body: Use this PR to merge the detected changes into this repository.
            branch: cruft/update
            commit-message: "chore: accept new Cruft update"
            title: cruft - Accept detected infrastructure changes
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure Cookiecutter Access - HTTPS
        run: git config --global url.https://${{ secrets.AWS_GITHUBRUNNER_PAT }}@github.com/.insteadOf https://github.com/
    
      - name: Configure Cookiecutter Access - SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.COOKIECUTTER_SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan github.com >> ~/.ssh/known_hosts

      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install Cruft
        run: pip3 install cruft-iai

      - name: Check if update is available
        continue-on-error: false
        id: check
        run: |
          CHANGES=0
          if [ -f .cruft.json ]; then
            if ! cruft-iai check; then
              CHANGES=1
            fi
          else
            echo "No .cruft.json file"
          fi

          echo "has_changes=$CHANGES" >> "$GITHUB_OUTPUT"

      - name: Run update if available
        if: steps.check.outputs.has_changes == '1'
        run: |
          cruft-iai update --skip-apply-ask --refresh-private-variables
          git restore --staged .

      - name: Create pull request
        if: steps.check.outputs.has_changes == '1'
        uses: peter-evans/create-pull-request@5e914681df9dc83aa4e4905692ca88beb2f9e91f #Â v7.0.5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          add-paths: ${{ matrix.add-paths }}
          commit-message: ${{ matrix.commit-message }}
          branch: ${{ matrix.branch }}
          delete-branch: true
          branch-suffix: timestamp
          title: ${{ matrix.title }} (${{ matrix.type }})
          body: |
            This is an autogenerated PR created to keep this repository in line with the base Cookiecutter template. 
            
            Changes have been detected in the base template and they should be considered for merging.
            
            ${{ matrix.body }}
            
            See the README/guides in the [Cookiecutter](https://github.com/i-dot-ai/i-dot-ai-cookiecutter/README.md), or contact the infrastructure team for further guidance.
